<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Просмотр Базы Данных</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Proxima+Nova:wght@400;600&display=swap');
        
        body {
            display: flex;
            font-family: 'Proxima Nova', sans-serif;
            font-weight: 400;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            height: 100vh;
        }
        .sidebar {
            width: 250px;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            display: flex;
            flex-direction: column;
            box-shadow: 3px 0 8px rgba(0,0,0,0.2);
        }
        .sidebar img {
            max-width: 100%;
            margin-bottom: 20px;
        }
        .sidebar label, .sidebar select, .sidebar button {
            margin-bottom: 15px;
            font-family: 'Proxima Nova', sans-serif;
            font-weight: 600;
        }
        .sidebar select, .sidebar button {
            padding: 10px;
            border: none;
            border-radius: 5px;
        }
        .sidebar select {
            background-color: #fff;
            color: #333;
        }
        .sidebar button {
            background-color: #00A651;
            color: #fff;
            cursor: pointer;
        }
        .sidebar button:hover {
            background-color: #008C45;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow: auto;
            font-family: 'Proxima Nova', sans-serif;
            font-weight: 400;
        }
        .main-content section {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 10px;
            box-shadow: 3px 0 8px rgba(0,0,0,0.2);
        }
        .main-content section .toggle-button, .main-content section .submit-json-button {
            padding: 10px;
            background-color: #00A651;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
            font-family: 'Proxima Nova', sans-serif;
            font-weight: 600;
        }
        .main-content section .toggle-button:hover, .main-content section .submit-json-button:hover {
            background-color: #008C45;
        }
        .main-content section input[type="text"] {
            width: calc(100% - 22px);
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: 'Proxima Nova', sans-serif;
            font-weight: 400;
        }
        table.dataTable {
            width: 100% !important;
            border-collapse: collapse;
        }
        table.dataTable th, table.dataTable td {
            padding: 8px;
            border: 1px solid #ddd;
            vertical-align: top;
            word-wrap: break-word;
            white-space: normal;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        table.dataTable thead th {
            background-color: #6a6a6a;
            color: #fff;
            text-align: left;
        }
        table.dataTable tbody tr:hover {
            background-color: #f1f1f1;
        }
        .hidden {
            display: none;
        }
        .data {
            border-collapse: collapse;
            width: 100%;
        }
        .data th, .data td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        .arrow-down::after {
            content: " \25BC";
            font-size: 12px;
        }
        #notification {
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            font-family: 'Proxima Nova', sans-serif;
            font-weight: 600;
            text-align: center;
        }
        #notification.success {
            background-color: #00A651;
            color: #fff;
        }
        #notification.error {
            background-color: #ff4c4c;
            color: #fff;
        }
        #notification.duplicate {
            background-color: #FFA500;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <img src="https://www.bcc.kz/storage/app/media/logotype.svg" alt="BCC Bank Logo">
        <label for="language">Выбрать Язык:</label>
        <select id="language" name="language">
            <option value="russian" selected>Русский</option>
            <option value="kazakh">Казахский</option>
        </select>
        <label for="table">Выбрать Таблицу:</label>
        <select id="table" name="table">
            <option value="">--Выбрать Таблицу--</option>
        </select>
        <label for="backup">Выбрать Резервную Копию:</label>
        <select id="backup" name="backup">
            <option value="">--Не Выбрано--</option>
        </select>
        <button id="restore-button">Восстановить</button>
        <button id="show-current-button">Показать Текущие Данные</button>
        <div id="notification" class="hidden"></div>
    </div>
    <div class="main-content">
        <section id="insert-section" class="hidden">
            <button class="toggle-button" id="toggle-insert-section">Показать Раздел Вставки</button>
            <div class="section-content">
                <form id="insert-form">
                    <label for="question">Вопрос:</label>
                    <input type="text" id="question" name="question"><br>
                    <label for="answer">Ответ:</label>
                    <input type="text" id="answer" name="answer"><br>
                    <label for="data_type">Тип Данных:</label>
                    <input type="text" id="data_type" name="data_type" value="manual"><br>
                    <button type="submit" class="submit-json-button">Отправить</button>
                </form>
                <button id="toggle-json-section" class="toggle-button arrow-down">Вставить JSON</button>
                <div id="json-section" class="hidden">
                    <textarea id="json-input" rows="10" cols="50" placeholder="Вставьте JSON данные здесь"></textarea>
                    <button id="insert-json-button" class="submit-json-button">Отправить JSON</button>
                </div>
            </div>
        </section>

        <section id="search-section" class="hidden">
            <button class="toggle-button" id="toggle-search-section">Показать Раздел Поиска</button>
            <div class="section-content">
                <form id="search-form">
                    <label for="query">Запрос:</label>
                    <input type="text" id="query" name="query"><br>
                    <button type="submit" class="submit-json-button">Отправить</button>
                    <button type="button" id="clear-results" class="submit-json-button">Очистить Результаты</button>
                </form>
                <div id="search-results"></div>
            </div>
        </section>

        <section id="table-section">
            <button class="toggle-button" id="toggle-table-section">Скрыть Раздел Таблицы</button>
            <div class="section-content">
                <button id="reverse-button" class="toggle-button">Обратить Порядок</button>
                <table id="table-content" class="display" style="width:100%">
                    <thead>
                        <tr id="table-headers"></tr>
                    </thead>
                    <tbody id="table-rows"></tbody>
                </table>
            </div>
        </section>
    </div>
    <script>
        $(document).ready(function() {
            var originalValues = {};

            function fetchTableContent(language, table) {
                $.ajax({
                    type: 'POST',
                    url: '/get_table_content',
                    contentType: 'application/json',
                    data: JSON.stringify({ language: language, table: table }),
                    success: function(response) {
                        displayTableContent(response.columns, response.content);
                    }
                });
            }

            function fetchBackupContent(language, table, backup) {
                $.ajax({
                    type: 'POST',
                    url: '/get_backup_content',
                    contentType: 'application/json',
                    data: JSON.stringify({ language: language, table: table, backup: backup }),
                    success: function(response) {
                        displayTableContent(response.columns, response.content);
                    }
                });
            }

            function displayTableContent(headers, content) {
                if ($.fn.DataTable.isDataTable('#table-content')) {
                    $('#table-content').DataTable().destroy();
                }

                $('#table-headers').empty();
                $('#table-rows').empty();
                originalValues = {};

                $.each(headers, function(index, header) {
                    $('#table-headers').append('<th>' + header + '</th>');
                });
                $('#table-headers').append('<th>Действие</th>');

                $.each(content, function(index, row) {
                    var rowHtml = '<tr>';
                    $.each(row, function(i, cell) {
                        var cellId = 'row-' + index + '-col-' + i;
                        rowHtml += '<td id="' + cellId + '" contenteditable="true" data-column="' + headers[i] + '" data-row-id="' + row[0] + '">' + cell + '</td>';
                        originalValues[cellId] = cell;
                    });
                    rowHtml += '<td><button class="delete-row" data-row-id="' + row[0] + '">Удалить</button></td>';
                    rowHtml += '</tr>';
                    $('#table-rows').append(rowHtml);
                });

                $('#table-content').DataTable();
            }

            function fetchBackups(language, table) {
                $.ajax({
                    type: 'POST',
                    url: '/get_backups',
                    contentType: 'application/json',
                    data: JSON.stringify({ language: language, table: table }),
                    success: function(response) {
                        $('#backup').empty().append('<option value="">--Не Выбрано--</option>');
                        $.each(response, function(index, backup) {
                            $('#backup').append('<option value="' + backup + '">' + backup + '</option>');
                        });
                    }
                });
            }

            function reverseTable() {
                var rows = $('#table-rows').children().toArray();
                $('#table-rows').empty().append(rows.reverse());
            }

            function showNotification(message, type) {
                var notification = $('#notification');
                notification.removeClass('hidden').removeClass('success error duplicate').addClass(type).text(message);
                setTimeout(function() {
                    notification.addClass('hidden');
                }, 3000);
            }

            $('#reverse-button').click(function() {
                reverseTable();
            });

            $('#language').change(function() {
                var language = $(this).val();
                $.ajax({
                    type: 'POST',
                    url: '/get_tables',
                    contentType: 'application/json',
                    data: JSON.stringify({ language: language }),
                    success: function(response) {
                        $('#table').empty().append('<option value="">--Выбрать Таблицу--</option>');
                        $.each(response, function(index, table) {
                            $('#table').append('<option value="' + table + '">' + table + '</option>');
                        });
                    }
                });
            });

            $('#table').change(function() {
                var language = $('#language').val();
                var table = $(this).val();
                if (language && table) {
                    $('#insert-section').removeClass('hidden');
                    $('#toggle-insert-section').text('Скрыть Раздел Вставки');
                    $('#table-section').removeClass('hidden');
                    $('#toggle-table-section').text('Скрыть Раздел Таблицы');
                    $('#search-section').removeClass('hidden');
                    $('#toggle-search-section').text('Скрыть Раздел Поиска');
                    fetchTableContent(language, table);
                    fetchBackups(language, table);
                } else {
                    $('#insert-section').addClass('hidden');
                    $('#table-section').addClass('hidden');
                    $('#search-section').addClass('hidden');
                }
            });

            $('#backup').change(function() {
                var language = $('#language').val();
                var table = $('#table').val();
                var backup = $(this).val();
                if (backup === "") {
                    fetchTableContent(language, table);
                } else if (language && table && backup) {
                    fetchBackupContent(language, table, backup);
                }
            });

            $('#restore-button').click(function() {
                var language = $('#language').val();
                var table = $('#table').val();
                var backup = $('#backup').val();
                if (language && table && backup) {
                    $.ajax({
                        type: 'POST',
                        url: '/restore_backup',
                        contentType: 'application/json',
                        data: JSON.stringify({ language: language, table: table, backup: backup }),
                        success: function(response) {
                            if (response.success) {
                                fetchTableContent(language, table);
                                showNotification('Восстановление успешно', 'success');
                            } else {
                                showNotification('Восстановление не удалось', 'error');
                            }
                        }
                    });
                }
            });

            $('#show-current-button').click(function() {
                var language = $('#language').val();
                var table = $('#table').val();
                if (language && table) {
                    fetchTableContent(language, table);
                }
            });

            $(document).on('blur', 'td[contenteditable="true"]', function() {
                var cellId = $(this).attr('id');
                var new_value = $(this).text();
                var original_value = originalValues[cellId];
                
                if (new_value !== original_value) {
                    var column = $(this).data('column');
                    var row_id = $(this).data('row-id');
                    var language = $('#language').val();
                    var table = $('#table').val();
                    $.ajax({
                        type: 'POST',
                        url: '/update_cell',
                        contentType: 'application/json',
                        data: JSON.stringify({ language: language, table: table, column: column, row_id: row_id, new_value: new_value }),
                        success: function(response) {
                            if (response.success) {
                                originalValues[cellId] = new_value;
                                fetchBackups(language, table);
                                showNotification('Обновление успешно', 'success');
                            } else {
                                showNotification('Обновление не удалось', 'error');
                            }
                        }
                    });
                }
            });

            $(document).on('click', '.delete-row', function() {
                var row_id = $(this).data('row-id');
                var language = $('#language').val();
                var table = $('#table').val();
                $.ajax({
                    type: 'POST',
                    url: '/delete_row',
                    contentType: 'application/json',
                    data: JSON.stringify({ language: language, table: table, row_id: row_id }),
                    success: function(response) {
                        if (response.success) {
                            fetchTableContent(language, table);
                            fetchBackups(language, table);
                            showNotification('Удаление успешно', 'success');
                        } else {
                            showNotification('Удаление не удалось', 'error');
                        }
                    }
                });
            });

            $('#insert-form').submit(function(event) {
                event.preventDefault();
                var question = $('#question').val();
                var answer = $('#answer').val();
                var data_type = $('#data_type').val();
                var language = $('#language').val();
                var table = $('#table').val();
                if (language && table && question && answer) {
                    $.ajax({
                        type: 'POST',
                        url: '/get_last_row_id',
                        contentType: 'application/json',
                        data: JSON.stringify({ language: language, table: table }),
                        success: function(response) {
                            var question_id = response.last_row_id + 1;
                            var new_data = [{ question: question, answer: answer, question_id: question_id, data_type: data_type }];
                            $.ajax({
                                type: 'POST',
                                url: '/insert_data',
                                contentType: 'application/json',
                                data: JSON.stringify({ language: language, table: table, data: new_data }),
                                success: function(response) {
                                    if (response.success) {
                                        fetchTableContent(language, table);
                                        fetchBackups(language, table);
                                        if (response.duplicate) {
                                            showNotification('Вставка успешна, но вопрос уже существует', 'duplicate');
                                        } else {
                                            showNotification('Вставка успешна', 'success');
                                        }
                                    } else {
                                        showNotification('Вставка не удалась', 'error');
                                    }
                                }
                            });
                        }
                    });
                }
            });

            $('#toggle-json-section').click(function() {
                $('#json-section').toggle();
            });

            $('#insert-json-button').click(function() {
                var jsonInput = $('#json-input').val();
                var language = $('#language').val();
                var table = $('#table').val();
                try {
                    var jsonData = JSON.parse(jsonInput);
                    if (Array.isArray(jsonData) && jsonData.length > 0) {
                        $.ajax({
                            type: 'POST',
                            url: '/insert_json',
                            contentType: 'application/json',
                            data: JSON.stringify({ language: language, table: table, data: jsonData }),
                            success: function(response) {
                                if (response.success) {
                                    fetchTableContent(language, table);
                                    fetchBackups(language, table);
                                    if (response.duplicate) {
                                        showNotification('Вставка JSON успешна, но некоторые вопросы уже существуют', 'duplicate');
                                    } else {
                                        showNotification('Вставка JSON успешна', 'success');
                                    }
                                } else {
                                    showNotification('Вставка JSON не удалась', 'error');
                                }
                            }
                        });
                    } else {
                        alert('Неверный формат JSON');
                    }
                } catch (e) {
                    alert('Неверный формат JSON');
                }
            });

            $('#toggle-insert-section').click(function() {
                var buttonText = $(this).text();
                if (buttonText === 'Скрыть Раздел Вставки') {
                    $('#insert-section .section-content').hide();
                    $(this).text('Показать Раздел Вставки');
                } else {
                    $('#insert-section .section-content').show();
                    $(this).text('Скрыть Раздел Вставки');
                }
            });

            $('#toggle-search-section').click(function() {
                var buttonText = $(this).text();
                if (buttonText === 'Скрыть Раздел Поиска') {
                    $('#search-section .section-content').hide();
                    $(this).text('Показать Раздел Поиска');
                } else {
                    $('#search-section .section-content').show();
                    $(this).text('Скрыть Раздел Поиска');
                }
            });

            $('#toggle-table-section').click(function() {
                var buttonText = $(this).text();
                if (buttonText === 'Скрыть Раздел Таблицы') {
                    $('#table-section .section-content').hide();
                    $(this).text('Показать Раздел Таблицы');
                } else {
                    $('#table-section .section-content').show();
                    $(this).text('Скрыть Раздел Таблицы');
                }
            });

            $('#search-form').submit(function(event) {
                event.preventDefault();
                var query = $('#query').val();
                var table_type = $('#table').val();
                if (query && table_type) {
                    $.ajax({
                        type: 'POST',
                        url: '/search',
                        contentType: 'application/json',
                        data: JSON.stringify({ query: query, table_type: table_type }),
                        success: function(response) {
                            if (response.success) {
                                var searchResults = response.results;
                                if (searchResults.length > 0) {
                                    var tableHtml = '<table class="data"><thead><tr>';
                                    $.each(Object.keys(searchResults[0]), function(index, key) {
                                        tableHtml += '<th>' + key + '</th>';
                                    });
                                    tableHtml += '</tr></thead><tbody>';
                                    $.each(searchResults, function(index, row) {
                                        tableHtml += '<tr>';
                                        $.each(row, function(key, value) {
                                            tableHtml += '<td>' + value + '</td>';
                                        });
                                        tableHtml += '</tr>';
                                    });
                                    tableHtml += '</tbody></table>';
                                    $('#search-results').html(tableHtml);
                                } else {
                                    $('#search-results').html('Результаты не найдены');
                                }
                            } else {
                                $('#search-results').html('Произошла ошибка при получении результатов.');
                            }
                        }
                    });
                }
            });

            $('#clear-results').click(function() {
                $('#search-results').empty();
            });

            $('#language').trigger('change');
        });
    </script>
</body>
</html>
