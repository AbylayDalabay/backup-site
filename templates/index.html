<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Database Viewer</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            height: 100vh;
        }
        .sidebar {
            width: 250px;
            padding: 20px;
            background-color: #3a3a3a;
            color: #fff;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar label, .sidebar select, .sidebar button {
            margin-bottom: 15px;
        }
        .sidebar select, .sidebar button {
            padding: 10px;
            border: none;
            border-radius: 5px;
        }
        .sidebar select {
            background-color: #fff;
            color: #333;
        }
        .sidebar button {
            background-color: #5a5a5a;
            color: #fff;
            cursor: pointer;
        }
        .sidebar button:hover {
            background-color: #6a6a6a;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow: auto;
        }
        .main-content section {
            margin-bottom: 20px;
        }
        .main-content section .toggle-button, .main-content section .submit-json-button {
            padding: 10px;
            background-color: #5a5a5a;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .main-content section .toggle-button:hover, .main-content section .submit-json-button:hover {
            background-color: #6a6a6a;
        }
        table.dataTable {
            width: 100% !important;
            border-collapse: collapse;
        }
        table.dataTable th, table.dataTable td {
            padding: 8px;
            border: 1px solid #ddd;
        }
        table.dataTable thead th {
            background-color: #6a6a6a;
            color: #fff;
        }
        table.dataTable tbody tr:hover {
            background-color: #f1f1f1;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <label for="language">Select Language:</label>
        <select id="language" name="language">
            <option value="russian" selected>Russian</option>
            <option value="kazakh">Kazakh</option>
        </select>
        <label for="table">Select Table:</label>
        <select id="table" name="table">
            <option value="">--Select Table--</option>
        </select>
        <label for="backup">Select Backup:</label>
        <select id="backup" name="backup">
            <option value="">--Not Selected--</option>
        </select>
        <button id="restore-button">Restore</button>
        <button id="show-current-button">Show Current Data</button>
    </div>
    <div class="main-content">
        <section id="insert-section" class="hidden">
            <button class="toggle-button" id="toggle-insert-section">Show Insert Section</button>
            <div class="section-content">
                <form id="insert-form">
                    <label for="question">Question:</label>
                    <input type="text" id="question" name="question"><br>
                    <label for="answer">Answer:</label>
                    <input type="text" id="answer" name="answer"><br>
                    <label for="data_type">Data Type:</label>
                    <input type="text" id="data_type" name="data_type" value="manual"><br>
                    <button type="submit">Submit</button>
                </form>
                <button id="toggle-json-section" class="toggle-button">Insert JSON</button>
                <div id="json-section" class="hidden">
                    <textarea id="json-input" rows="10" cols="50" placeholder="Enter JSON data here"></textarea>
                    <button id="insert-json-button" class="submit-json-button">Submit JSON</button>
                </div>
            </div>
        </section>

        <section id="table-section">
            <button class="toggle-button" id="toggle-table-section">Hide Table Section</button>
            <div class="section-content">
                <button id="reverse-button" class="toggle-button">Reverse Order</button>
                <table id="table-content" class="display" style="width:100%">
                    <thead>
                        <tr id="table-headers"></tr>
                    </thead>
                    <tbody id="table-rows"></tbody>
                </table>
            </div>
        </section>
    </div>
    <script>
        $(document).ready(function() {
            var originalValues = {};
            var selectedTable = ""; // Global variable to store the selected table name
    
            function fetchTableContent(language, table) {
                $.ajax({
                    type: 'POST',
                    url: '/get_table_content',
                    contentType: 'application/json',
                    data: JSON.stringify({ language: language, table: table }),
                    success: function(response) {
                        displayTableContent(response.columns, response.content);
                    }
                });
            }
    
            function fetchBackupContent(language, table, backup) {
                $.ajax({
                    type: 'POST',
                    url: '/get_backup_content',
                    contentType: 'application/json',
                    data: JSON.stringify({ language: language, table: table, backup: backup }),
                    success: function(response) {
                        displayTableContent(response.columns, response.content);
                    }
                });
            }
    
            function displayTableContent(headers, content) {
                $('#table-headers').empty();
                $('#table-rows').empty();
                originalValues = {};
    
                $.each(headers, function(index, header) {
                    $('#table-headers').append('<th>' + header + '</th>');
                });
                $('#table-headers').append('<th>Action</th>');
    
                $.each(content, function(index, row) {
                    var rowHtml = '<tr>';
                    $.each(row, function(i, cell) {
                        var cellId = 'row-' + index + '-col-' + i;
                        rowHtml += '<td id="' + cellId + '" contenteditable="true" data-column="' + headers[i] + '" data-row-id="' + (index + 1) + '">' + cell + '</td>';
                        originalValues[cellId] = cell;
                    });
                    rowHtml += '<td><button class="delete-row" data-row-id="' + (index + 1) + '">Delete</button></td>';
                    rowHtml += '</tr>';
                    $('#table-rows').append(rowHtml);
                });
                $('#table-content').DataTable();
            }
    
            function fetchBackups(language, table) {
                $.ajax({
                    type: 'POST',
                    url: '/get_backups',
                    contentType: 'application/json',
                    data: JSON.stringify({ language: language, table: table }),
                    success: function(response) {
                        $('#backup').empty().append('<option value="">--Not Selected--</option>');
                        $.each(response, function(index, backup) {
                            $('#backup').append('<option value="' + backup + '">' + backup + '</option>');
                        });
                    }
                });
            }
    
            function reverseTable() {
                var rows = $('#table-rows').children().toArray();
                $('#table-rows').empty().append(rows.reverse());
            }
    
            $('#reverse-button').click(function() {
                reverseTable();
            });
    
            $('#language').change(function() {
                var language = $(this).val();
                $.ajax({
                    type: 'POST',
                    url: '/get_tables',
                    contentType: 'application/json',
                    data: JSON.stringify({ language: language }),
                    success: function(response) {
                        $('#table').empty().append('<option value="">--Select Table--</option>');
                        $.each(response, function(index, table) {
                            $('#table').append('<option value="' + table + '">' + table + '</option>');
                        });
                    }
                });
            });
    
            $('#table').change(function() {
                var language = $('#language').val();
                selectedTable = $(this).val(); // Update the global variable with the selected table name
                if (language && selectedTable) {
                    $('#insert-section').removeClass('hidden');
                    $('#toggle-insert-section').text('Hide Insert Section');
                    $('#table-section').removeClass('hidden');
                    $('#toggle-table-section').text('Hide Table Section');
                    fetchTableContent(language, selectedTable);
                    fetchBackups(language, selectedTable);
                } else {
                    $('#insert-section').addClass('hidden');
                    $('#table-section').addClass('hidden');
                }
            });
    
            $('#backup').change(function() {
                var language = $('#language').val();
                var backup = $(this).val();
                if (backup === "") {
                    fetchTableContent(language, selectedTable);
                } else if (language && selectedTable && backup) {
                    fetchBackupContent(language, selectedTable, backup);
                }
            });
    
            $('#restore-button').click(function() {
                var language = $('#language').val();
                var backup = $('#backup').val();
                if (language && selectedTable && backup) {
                    $.ajax({
                        type: 'POST',
                        url: '/restore_backup',
                        contentType: 'application/json',
                        data: JSON.stringify({ language: language, table: selectedTable, backup: backup }),
                        success: function(response) {
                            if (response.success) {
                                fetchTableContent(language, selectedTable);
                            }
                        }
                    });
                }
            });
    
            $('#show-current-button').click(function() {
                var language = $('#language').val();
                if (language && selectedTable) {
                    fetchTableContent(language, selectedTable);
                }
            });
    
            $(document).on('blur', 'td[contenteditable="true"]', function() {
                var cellId = $(this).attr('id');
                var new_value = $(this).text();
                var original_value = originalValues[cellId];
                
                if (new_value !== original_value) {
                    var column = $(this).data('column');
                    var row_id = $(this).data('row-id');
                    var language = $('#language').val();
                    $.ajax({
                        type: 'POST',
                        url: '/update_cell',
                        contentType: 'application/json',
                        data: JSON.stringify({ language: language, table: selectedTable, column: column, row_id: row_id, new_value: new_value }),
                        success: function(response) {
                            if (response.success) {
                                originalValues[cellId] = new_value;
                                fetchBackups(language, selectedTable);
                            }
                        }
                    });
                }
            });
    
            $(document).on('click', '.delete-row', function() {
                var row_id = $(this).data('row-id');
                var language = $('#language').val();
                $.ajax({
                    type: 'POST',
                    url: '/delete_row',
                    contentType: 'application/json',
                    data: JSON.stringify({ language: language, table: selectedTable, row_id: row_id }),
                    success: function(response) {
                        if (response.success) {
                            $('#table').trigger('change');
                            fetchBackups(language, selectedTable);
                        }
                    }
                });
            });
    
            $('#insert-form').submit(function(event) {
                event.preventDefault();
                var question = $('#question').val();
                var answer = $('#answer').val();
                var data_type = $('#data_type').val();
                var language = $('#language').val();
                if (language && selectedTable && question && answer) {
                    $.ajax({
                        type: 'POST',
                        url: '/get_last_row_id',
                        contentType: 'application/json',
                        data: JSON.stringify({ language: language, table: selectedTable }),
                        success: function(response) {
                            var question_id = response.last_row_id + 1;
                            var new_data = [{ question: question, answer: answer, question_id: question_id, data_type: data_type }];
                            $.ajax({
                                type: 'POST',
                                url: '/insert_data',
                                contentType: 'application/json',
                                data: JSON.stringify({ language: language, table: selectedTable, data: new_data }),
                                success: function(response) {
                                    if (response.success) {
                                        fetchTableContent(language, selectedTable);
                                        fetchBackups(language, selectedTable);
                                    }
                                }
                            });
                        }
                    });
                }
            });
    
            $('#toggle-json-section').click(function() {
                $('#json-section').toggle();
            });
    
            $('#insert-json-button').click(function() {
                var jsonInput = $('#json-input').val();
                var language = $('#language').val();
                try {
                    var jsonData = JSON.parse(jsonInput);
                    if (Array.isArray(jsonData) && jsonData.length > 0) {
                        $.ajax({
                            type: 'POST',
                            url: '/insert_json',
                            contentType: 'application/json',
                            data: JSON.stringify({ language: language, table: selectedTable, data: jsonData }),
                            success: function(response) {
                                if (response.success) {
                                    fetchTableContent(language, selectedTable);
                                    fetchBackups(language, selectedTable);
                                }
                            }
                        });
                    } else {
                        alert('Invalid JSON format');
                    }
                } catch (e) {
                    alert('Invalid JSON format');
                }
            });
    
            $('#toggle-insert-section').click(function() {
                var buttonText = $(this).text();
                if (buttonText === 'Hide Insert Section') {
                    $('#insert-section .section-content').hide();
                    $(this).text('Show Insert Section');
                } else {
                    $('#insert-section .section-content').show();
                    $(this).text('Hide Insert Section');
                }
            });
    
            $('#toggle-table-section').click(function() {
                var buttonText = $(this).text();
                if (buttonText === 'Hide Table Section') {
                    $('#table-section .section-content').hide();
                    $(this).text('Show Table Section');
                } else {
                    $('#table-section .section-content').show();
                    $(this).text('Hide Table Section');
                }
            });
    
            $('#language').trigger('change');
        });
    </script>
</body>
</html>
