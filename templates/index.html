<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Database Viewer</title>
    <style>
        body {
            display: flex;
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            height: 100vh;
        }
        .sidebar {
            width: 250px;
            padding: 20px;
            background-color: #3a3a3a;
            color: #fff;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar label, .sidebar select, .sidebar button {
            margin-bottom: 15px;
        }
        .sidebar select, .sidebar button {
            padding: 10px;
            border: none;
            border-radius: 5px;
        }
        .sidebar select {
            background-color: #fff;
            color: #333;
        }
        .sidebar button {
            background-color: #5a5a5a;
            color: #fff;
            cursor: pointer;
        }
        .sidebar button:hover {
            background-color: #6a6a6a;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow: auto;
        }
        .main-content section {
            margin-bottom: 20px;
        }
        .main-content section .toggle-button, 
        .main-content section .submit-json-button,
        .main-content section button {
            padding: 10px;
            background-color: #5a5a5a;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        .main-content section .toggle-button:hover, 
        .main-content section .submit-json-button:hover,
        .main-content section button:hover {
            background-color: #6a6a6a;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        table th, table td {
            padding: 8px;
            border: 1px solid #ddd;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        table thead th {
            background-color: #6a6a6a;
            color: #fff;
        }
        table tbody tr:hover {
            background-color: #f1f1f1;
        }
        .action-cell {
            width: 100px; /* Smaller width for action cells */
        }
        .hidden {
            display: none;
        }
        .expanded {
            white-space: normal;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .form-group textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            resize: vertical;
        }
        .search-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .search-container input {
            flex: 1;
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 50px;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .search-container button {
            margin-left: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background-color: #5a5a5a;
            color: #fff;
            cursor: pointer;
        }
        .search-container button:hover {
            background-color: #6a6a6a;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <label for="language">Select Language:</label>
        <select id="language" name="language">
            <option value="russian" selected>Russian</option>
            <option value="kazakh">Kazakh</option>
        </select>
        <label for="table">Select Table:</label>
        <select id="table" name="table">
            <option value="">--Select Table--</option>
        </select>
        <label for="backup">Select Backup:</label>
        <select id="backup" name="backup">
            <option value="">--Not Selected--</option>
        </select>
        <button id="restore-button">Restore</button>
        <button id="show-current-button">Show Current Data</button>
    </div>
    <div class="main-content">
        <section id="insert-section" class="hidden">
            <button class="toggle-button" id="toggle-insert-section">Show Insert Section</button>
            <div class="section-content">
                <form id="insert-form">
                    <div class="form-group">
                        <label for="question">Question:</label>
                        <input type="text" id="question" name="question">
                    </div>
                    <div class="form-group">
                        <label for="answer">Answer:</label>
                        <textarea id="answer" name="answer" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="data_type">Data Type:</label>
                        <input type="text" id="data_type" name="data_type" value="manual">
                    </div>
                    <button type="submit">Submit</button>
                </form>
                <button id="toggle-json-section" class="toggle-button">Insert JSON</button>
                <div id="json-section" class="hidden">
                    <textarea id="json-input" rows="10" cols="50" placeholder="Enter JSON data here"></textarea>
                    <button id="insert-json-button" class="submit-json-button">Submit JSON</button>
                </div>
            </div>
        </section>

        <section id="table-section">
            <button class="toggle-button" id="toggle-table-section">Hide Table Section</button>
            <div class="section-content">
                <button id="reverse-button" class="toggle-button">Reverse Order</button>
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search...">
                    <button id="search-button">Search</button>
                </div>
                <table id="table-content">
                    <thead>
                        <tr id="table-headers"></tr>
                    </thead>
                    <tbody id="table-rows"></tbody>
                </table>
            </div>
        </section>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var originalValues = {};
            var currentLanguage = document.getElementById('language').value;
            var currentTable = "";

            function fetchTableContent(language, table) {
                fetch('/get_table_content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ language: language, table: table }),
                })
                .then(response => response.json())
                .then(data => displayTableContent(data.columns, data.content))
                .catch(error => console.error('Error:', error));
            }

            function fetchBackupContent(language, table, backup) {
                fetch('/get_backup_content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ language: language, table: table, backup: backup }),
                })
                .then(response => response.json())
                .then(data => displayTableContent(data.columns, data.content))
                .catch(error => console.error('Error:', error));
            }

            function displayTableContent(headers, content) {
                var tableHeaders = document.getElementById('table-headers');
                var tableRows = document.getElementById('table-rows');
                tableHeaders.innerHTML = '';
                tableRows.innerHTML = '';
                originalValues = {};

                headers.forEach(header => {
                    var th = document.createElement('th');
                    th.textContent = header;
                    tableHeaders.appendChild(th);
                });
                var actionTh = document.createElement('th');
                actionTh.textContent = 'Action';
                actionTh.className = 'action-cell';
                tableHeaders.appendChild(actionTh);

                content.forEach((row, rowIndex) => {
                    var tr = document.createElement('tr');
                    row.forEach((cell, cellIndex) => {
                        var td = document.createElement('td');
                        var cellId = 'row-' + rowIndex + '-col-' + cellIndex;
                        td.id = cellId;
                        td.contentEditable = true;
                        td.dataset.column = headers[cellIndex];
                        td.dataset.rowId = rowIndex + 1;
                        td.textContent = cell;
                        td.style.maxWidth = '150px';
                        td.style.cursor = 'pointer';
                        originalValues[cellId] = cell;
                        td.addEventListener('click', function() {
                            td.classList.toggle('expanded');
                        });
                        tr.appendChild(td);
                    });
                    var actionTd = document.createElement('td');
                    actionTd.className = 'action-cell';
                    var deleteButton = document.createElement('button');
                    deleteButton.className = 'delete-row';
                    deleteButton.dataset.rowId = rowIndex + 1;
                    deleteButton.textContent = 'Delete';
                    deleteButton.style.padding = '5px 10px';
                    deleteButton.style.backgroundColor = '#e74c3c';
                    deleteButton.style.color = '#fff';
                    deleteButton.style.border = 'none';
                    deleteButton.style.borderRadius = '3px';
                    deleteButton.style.cursor = 'pointer';
                    deleteButton.style.marginBottom = '15px';
                    deleteButton.style.marginTop = '10px';
                    deleteButton.style.marginRight = '5px';
                    actionTd.appendChild(deleteButton);
                    tr.appendChild(actionTd);
                    tableRows.appendChild(tr);
                });
            }

            function fetchBackups(language, table) {
                fetch('/get_backups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ language: language, table: table }),
                })
                .then(response => response.json())
                .then(data => {
                    var backupSelect = document.getElementById('backup');
                    backupSelect.innerHTML = '<option value="">--Not Selected--</option>';
                    data.forEach(backup => {
                        var option = document.createElement('option');
                        option.value = backup;
                        option.textContent = backup;
                        backupSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
            }

            function reverseTable() {
                var tableRows = document.getElementById('table-rows');
                var rows = Array.from(tableRows.children);
                tableRows.innerHTML = '';
                rows.reverse().forEach(row => tableRows.appendChild(row));
            }

            document.getElementById('reverse-button').addEventListener('click', reverseTable);

            document.getElementById('language').addEventListener('change', function() {
                var language = this.value;
                currentLanguage = language;
                fetch('/get_tables', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ language: language }),
                })
                .then(response => response.json())
                .then(data => {
                    var tableSelect = document.getElementById('table');
                    tableSelect.innerHTML = '<option value="">--Select Table--</option>';
                    data.forEach(table => {
                        var option = document.createElement('option');
                        option.value = table;
                        option.textContent = table;
                        tableSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
            });

            document.getElementById('table').addEventListener('change', function() {
                var table = this.value;
                currentTable = table;
                if (currentLanguage && table) {
                    document.getElementById('insert-section').classList.remove('hidden');
                    document.getElementById('toggle-insert-section').textContent = 'Hide Insert Section';
                    document.getElementById('table-section').classList.remove('hidden');
                    document.getElementById('toggle-table-section').textContent = 'Hide Table Section';
                    fetchTableContent(currentLanguage, table);
                    fetchBackups(currentLanguage, table);
                } else {
                    document.getElementById('insert-section').classList.add('hidden');
                    document.getElementById('table-section').classList.add('hidden');
                }
            });

            document.getElementById('backup').addEventListener('change', function() {
                var backup = this.value;
                if (backup === "") {
                    fetchTableContent(currentLanguage, currentTable);
                } else if (currentLanguage && currentTable && backup) {
                    fetchBackupContent(currentLanguage, currentTable, backup);
                }
            });

            document.getElementById('restore-button').addEventListener('click', function() {
                var backup = document.getElementById('backup').value;
                if (currentLanguage && currentTable && backup) {
                    fetch('/restore_backup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ language: currentLanguage, table: currentTable, backup: backup }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            fetchTableContent(currentLanguage, currentTable);
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            });

            document.getElementById('show-current-button').addEventListener('click', function() {
                if (currentLanguage && currentTable) {
                    fetchTableContent(currentLanguage, currentTable);
                }
            });

            document.addEventListener('blur', function(event) {
                if (event.target.matches('td[contenteditable="true"]')) {
                    var cell = event.target;
                    var cellId = cell.id;
                    var newValue = cell.textContent;
                    var originalValue = originalValues[cellId];
                    
                    if (newValue !== originalValue) {
                        var column = cell.dataset.column;
                        var rowId = cell.dataset.rowId;
                        fetch('/update_cell', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ language: currentLanguage, table: currentTable, column: column, row_id: rowId, new_value: newValue }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                originalValues[cellId] = newValue;
                                fetchBackups(currentLanguage, currentTable);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    }
                }
            }, true);

            document.addEventListener('click', function(event) {
                if (event.target.matches('.delete-row')) {
                    var rowId = event.target.dataset.rowId;
                    fetch('/delete_row', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ language: currentLanguage, table: currentTable, row_id: rowId }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            fetchTableContent(currentLanguage, currentTable);
                            fetchBackups(currentLanguage, currentTable);
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
            });

            document.getElementById('insert-form').addEventListener('submit', function(event) {
                event.preventDefault();
                var question = document.getElementById('question').value;
                var answer = document.getElementById('answer').value;
                var dataType = document.getElementById('data_type').value;
                if (currentLanguage && currentTable && question && answer) {
                    fetch('/get_last_row_id', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ language: currentLanguage, table: currentTable }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        var questionId = data.last_row_id + 1;
                        var newData = [{ question: question, answer: answer, question_id: questionId, data_type: dataType }];
                        fetch('/insert_data', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ language: currentLanguage, table: currentTable, data: newData }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                fetchTableContent(currentLanguage, currentTable);
                                fetchBackups(currentLanguage, currentTable);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    })
                    .catch(error => console.error('Error:', error));
                }
            });

            document.getElementById('toggle-json-section').addEventListener('click', function() {
                document.getElementById('json-section').classList.toggle('hidden');
            });

            document.getElementById('insert-json-button').addEventListener('click', function() {
                var jsonInput = document.getElementById('json-input').value;
                try {
                    var jsonData = JSON.parse(jsonInput);
                    if (Array.isArray(jsonData) && jsonData.length > 0) {
                        fetch('/insert_json', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ language: currentLanguage, table: currentTable, data: jsonData }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                fetchTableContent(currentLanguage, currentTable);
                                fetchBackups(currentLanguage, currentTable);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    } else {
                        alert('Invalid JSON format');
                    }
                } catch (e) {
                    alert('Invalid JSON format');
                }
            });

            document.getElementById('toggle-insert-section').addEventListener('click', function() {
                var sectionContent = document.querySelector('#insert-section .section-content');
                if (sectionContent.style.display === 'none') {
                    sectionContent.style.display = 'block';
                    this.textContent = 'Hide Insert Section';
                } else {
                    sectionContent.style.display = 'none';
                    this.textContent = 'Show Insert Section';
                }
            });

            document.getElementById('toggle-table-section').addEventListener('click', function() {
                var sectionContent = document.querySelector('#table-section .section-content');
                if (sectionContent.style.display === 'none') {
                    sectionContent.style.display = 'block';
                    this.textContent = 'Hide Table Section';
                } else {
                    sectionContent.style.display = 'none';
                    this.textContent = 'Show Table Section';
                }
            });

            document.getElementById('search-input').addEventListener('input', function() {
                var query = this.value;
                if (currentLanguage && currentTable) {
                fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query, table_type: currentTable }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayTableContent(data.results.columns, data.results.content);
                    }
                })
                .catch(error => console.error('Error:', error));
            }
            });

            document.getElementById('language').dispatchEvent(new Event('change'));
        });
    </script>
</body>
</html>
